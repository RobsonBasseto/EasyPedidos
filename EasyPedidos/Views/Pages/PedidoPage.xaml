<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:local="clr-namespace:EasyPedidos.Pages"
             xmlns:helpers="clr-namespace:EasyPedidos.Helpers"
             x:Class="EasyPedidos.Pages.PedidoPage"
             Title="{Binding Title}"
             BackgroundColor="#FFFFFF">

    <!-- RESOURCES -->
    <ContentPage.Resources>
        <ResourceDictionary>
            <!-- CONVERTERS -->
            <helpers:BoolToColorConverter x:Key="BoolToColorConverter" />
            <helpers:InverseBoolToColorConverter x:Key="InverseBoolToColorConverter" />
            <helpers:InverseBooleanConverter x:Key="InverseBooleanConverter" />
            <helpers:EnumToBoolWithDescriptionConverter x:Key="EnumToBoolDescConverter" />

            <!-- ESTILOS -->
            <Style x:Key="SectionTitle" TargetType="Label">
                <Setter Property="FontSize" Value="18" />
                <Setter Property="FontAttributes" Value="Bold" />
                <Setter Property="TextColor" Value="#FF6B35" />
                <Setter Property="Margin" Value="0,0,0,8" />
            </Style>

            <Style x:Key="InputFrame" TargetType="Frame">
                <Setter Property="BackgroundColor" Value="#F9F9F9" />
                <Setter Property="BorderColor" Value="#DDDDDD" />
                <Setter Property="CornerRadius" Value="12" />
                <Setter Property="Padding" Value="0" />
                <Setter Property="HasShadow" Value="False" />
            </Style>

            <Style x:Key="CardFrame" TargetType="Frame">
                <Setter Property="BackgroundColor" Value="#FFFFFF" />
                <Setter Property="CornerRadius" Value="20" />
                <Setter Property="Padding" Value="20" />
                <Setter Property="HasShadow" Value="False" />
                <Setter Property="BorderColor" Value="#EEEEEE" />
                <Setter Property="Margin" Value="0,0,0,20" />
            </Style>

            <Style x:Key="ActionButton" TargetType="Button">
                <Setter Property="BackgroundColor" Value="#FF6B35" />
                <Setter Property="TextColor" Value="White" />
                <Setter Property="FontAttributes" Value="Bold" />
                <Setter Property="FontSize" Value="16" />
                <Setter Property="CornerRadius" Value="14" />
                <Setter Property="HeightRequest" Value="55" />
                <Setter Property="Padding" Value="20,0" />
            </Style>

            <Style x:Key="CancelButton" TargetType="Button">
                <Setter Property="BackgroundColor" Value="#FF4444" />
                <Setter Property="TextColor" Value="White" />
                <Setter Property="FontAttributes" Value="Bold" />
                <Setter Property="FontSize" Value="16" />
                <Setter Property="CornerRadius" Value="14" />
                <Setter Property="HeightRequest" Value="55" />
                <Setter Property="Padding" Value="20,0" />
            </Style>
        </ResourceDictionary>
    </ContentPage.Resources>

    <ScrollView>
        <VerticalStackLayout Padding="25,40,25,30" Spacing="25">

            <!-- CABEÇALHO -->
            <VerticalStackLayout HorizontalOptions="Center" Spacing="12">
                <Image Source="logo.png" HeightRequest="50" WidthRequest="50" />
                <Label Text="Novo Pedido" FontSize="28" FontAttributes="Bold" TextColor="#FF6B35" HorizontalOptions="Center" />
            </VerticalStackLayout>

            <!-- 1. ITENS DO PEDIDO -->
            <Frame Style="{StaticResource CardFrame}">
                <Frame.Shadow>
                    <Shadow Brush="#20000000" Offset="0,6" Radius="12" />
                </Frame.Shadow>

                <VerticalStackLayout Spacing="16">
                    <Label Text="1. Itens do Pedido" Style="{StaticResource SectionTitle}" />

                    <!-- ADICIONAR ITEM -->
                    <Grid ColumnDefinitions="*,80" ColumnSpacing="12" HeightRequest="50">
                        <Frame Grid.Column="0" Style="{StaticResource InputFrame}">
                            <Picker
                                ItemsSource="{Binding Cardapio}"
                                SelectedItem="{Binding ItemSelecionado}"
                                ItemDisplayBinding="{Binding Descricao}"
                                Title="Selecione um item"
                                TextColor="#333333"
                                FontSize="15"
                                Margin="12,8" />
                        </Frame>
                        <Frame Grid.Column="1" Style="{StaticResource InputFrame}">
                            <Entry
                                Text="{Binding Quantidade}"
                                Placeholder="Qtd"
                                Keyboard="Numeric"
                                TextColor="#333333"
                                FontSize="15"
                                HorizontalTextAlignment="Center"
                                VerticalOptions="Center"
                                Margin="12,8" />
                        </Frame>
                    </Grid>

                    <Button
                        Text="Adicionar Item"
                        Command="{Binding AdicionarItemCommand}"
                        Style="{StaticResource ActionButton}"
                        ImageSource="plus_white.png"
                        HorizontalOptions="End" />

                    <!-- LISTA DE ITENS -->
                    <CollectionView
                        ItemsSource="{Binding Pedido.Itens}"
                        EmptyView="Nenhum item adicionado ainda."
                        HeightRequest="200">
                        <CollectionView.ItemTemplate>
                            <DataTemplate>
                                <Frame BackgroundColor="#FFF8F0" CornerRadius="14" Padding="14" Margin="0,6" HasShadow="False">
                                    <Frame.Shadow>
                                        <Shadow Brush="#10000000" Offset="0,2" Radius="6" />
                                    </Frame.Shadow>
                                    <Grid ColumnDefinitions="*,Auto,Auto" ColumnSpacing="12">
                                        <VerticalStackLayout Grid.Column="0" Spacing="4">
                                            <Label Text="{Binding Nome}" FontSize="15" FontAttributes="Bold" TextColor="#333" />
                                            <Label Text="{Binding Quantidade, StringFormat='{0}x'}" FontSize="13" TextColor="#777" />
                                            <Frame BackgroundColor="#FFF0E6" BorderColor="#FF6B35" CornerRadius="8" Padding="0" HasShadow="False">
                                                <Editor
                                                    Text="{Binding Observacao}"
                                                    Placeholder="Obs..."
                                                    TextColor="#555"
                                                    FontSize="12"
                                                    AutoSize="TextChanges"
                                                    MaximumHeightRequest="50"
                                                    Margin="10,6" />
                                            </Frame>
                                        </VerticalStackLayout>
                                        <Label
                                            Grid.Column="1"
                                            Text="{Binding Subtotal, StringFormat='R$ {0:F2}'}"
                                            FontSize="14"
                                            FontAttributes="Bold"
                                            TextColor="#FF6B35"
                                            VerticalOptions="Center" />
                                        <Button
                                            Grid.Column="2"
                                            Text="X"
                                            Command="{Binding Source={RelativeSource AncestorType={x:Type local:PedidoPage}}, Path=BindingContext.RemoverItemCommand}"
                                            CommandParameter="{Binding .}"
                                            BackgroundColor="#FF6B35"
                                            TextColor="White"
                                            FontSize="12"
                                            WidthRequest="36"
                                            HeightRequest="36"
                                            CornerRadius="18" />
                                    </Grid>
                                </Frame>
                            </DataTemplate>
                        </CollectionView.ItemTemplate>
                    </CollectionView>

                    <!-- TOTAL -->
                    <BoxView HeightRequest="1" BackgroundColor="#EEEEEE" />
                    <Grid ColumnDefinitions="*,Auto">
                        <Label Text="Total:" FontSize="20" FontAttributes="Bold" TextColor="#333" />
                        <Label Text="{Binding Pedido.Total, StringFormat='R$ {0:F2}'}"
                               FontSize="22"
                               FontAttributes="Bold"
                               TextColor="#FF6B35" />
                    </Grid>
                </VerticalStackLayout>
            </Frame>

            <!-- 2. LOCAL DE CONSUMO -->
            <Frame Style="{StaticResource CardFrame}">
                <Frame.Shadow>
                    <Shadow Brush="#20000000" Offset="0,6" Radius="12" />
                </Frame.Shadow>
                <VerticalStackLayout Spacing="12">
                    <Label Text="2. Onde vai consumir?" Style="{StaticResource SectionTitle}" />
                    <Grid ColumnDefinitions="*,*,*" ColumnSpacing="10">
                        <RadioButton 
                            Content="No Local"
                            IsChecked="{Binding Pedido.LocalConsumo, Converter={StaticResource EnumToBoolDescConverter}, ConverterParameter=NoLocal}" />
                        <RadioButton 
                            Content="Para Retirada"
                            IsChecked="{Binding Pedido.LocalConsumo, Converter={StaticResource EnumToBoolDescConverter}, ConverterParameter=Retirada}" />
                        <RadioButton 
                            Content="Para Entrega"
                            IsChecked="{Binding Pedido.LocalConsumo, Converter={StaticResource EnumToBoolDescConverter}, ConverterParameter=Entrega}" />
                    </Grid>
                </VerticalStackLayout>
            </Frame>

            <!-- 3. MESA OU CARRO -->
            <Frame IsVisible="{Binding Pedido.MostrarTipoAtendimento}" Style="{StaticResource CardFrame}">
                <Frame.Shadow>
                    <Shadow Brush="#20000000" Offset="0,6" Radius="12" />
                </Frame.Shadow>
                <VerticalStackLayout Spacing="12">
                    <Label Text="3. Mesa ou Carro?" Style="{StaticResource SectionTitle}" />

                    <!-- TIPO -->
                    <Grid ColumnDefinitions="*,*" ColumnSpacing="20">
                        <Frame BackgroundColor="{Binding Pedido.IsMesa, Converter={StaticResource BoolToColorConverter}, ConverterParameter=#FFF0E6|#F9F9F9}" CornerRadius="14" Padding="12" Grid.Column="0">
                            <RadioButton Content="Mesa" IsChecked="{Binding Pedido.IsMesa}" GroupName="Tipo" />
                        </Frame>
                        <Frame BackgroundColor="{Binding Pedido.IsMesa, Converter={StaticResource InverseBoolToColorConverter}, ConverterParameter=#FFF0E6|#F9F9F9}" CornerRadius="14" Padding="12" Grid.Column="1">
                            <RadioButton Content="Carro" IsChecked="{Binding Pedido.IsMesa, Converter={StaticResource InverseBooleanConverter}}" GroupName="Tipo" />
                        </Frame>
                    </Grid>

                    <!-- MESA -->
                    <StackLayout IsVisible="{Binding Pedido.IsMesa}" Spacing="8" Margin="0,8,0,0">
                        <Label Text="Selecione a Mesa:" FontSize="14" TextColor="#555" />
                        <Frame Style="{StaticResource InputFrame}">
                            <Picker
                                ItemsSource="{Binding Mesas}"
                                SelectedItem="{Binding Pedido.Identificador}"
                                TextColor="#333333"
                                FontSize="15"
                                Margin="12,8" />
                        </Frame>
                    </StackLayout>

                    <!-- CARRO -->
                    <StackLayout IsVisible="{Binding Pedido.IsMesa, Converter={StaticResource InverseBooleanConverter}}" Spacing="8" Margin="0,8,0,0">
                        <Label Text="Placa do Carro:" FontSize="14" TextColor="#555" />
                        <Frame Style="{StaticResource InputFrame}">
                            <Entry
                                Text="{Binding Pedido.Identificador}"
                                Placeholder="ABC-1234"
                                TextColor="#333333"
                                FontSize="15"
                                MaxLength="8"
                                Margin="12,8" />
                        </Frame>
                    </StackLayout>
                </VerticalStackLayout>
            </Frame>

            <!-- BOTÕES -->
            <Grid ColumnDefinitions="*,*" ColumnSpacing="16">
                <Button Text="Cancelar" Command="{Binding CancelarCommand}" Style="{StaticResource CancelButton}" Grid.Column="0" />
                <Button Text="Salvar Pedido" Command="{Binding SalvarPedidoCommand}" Style="{StaticResource ActionButton}" Grid.Column="1" />
            </Grid>

        </VerticalStackLayout>
    </ScrollView>
</ContentPage>