<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:local="clr-namespace:EasyPedidos.Pages"
             xmlns:helpers="clr-namespace:EasyPedidos.Helpers"
             x:Class="EasyPedidos.Pages.PedidoPage"
             Title="{Binding Title}">

    <ContentPage.Resources>
        <ResourceDictionary>
            <helpers:BoolToColorConverter x:Key="BoolToColorConverter" />
            <helpers:InverseBoolToColorConverter x:Key="InverseBoolToColorConverter" />
            <helpers:InverseBooleanConverter x:Key="InverseBooleanConverter" />
        </ResourceDictionary>
    </ContentPage.Resources>

    <ScrollView>
        <VerticalStackLayout Padding="20" Spacing="15">

            <!-- CABEÇALHO -->
            <Label Text="Novo Pedido"
                   FontSize="24"
                   FontAttributes="Bold"
                   HorizontalOptions="Center" />

            <!-- 1. ITENS DO PEDIDO -->
            <Frame BackgroundColor="SlateGray" Padding="15">
                <VerticalStackLayout Spacing="10">
                    <Label Text="Itens do Pedido:"
                           FontSize="18"
                           FontAttributes="Bold" />

                    <!-- Adicionar Item -->
                    <Grid ColumnDefinitions="*, Auto" ColumnSpacing="10">
                        <Picker ItemsSource="{Binding Cardapio}"
                                SelectedItem="{Binding ItemSelecionado}"
                                ItemDisplayBinding="{Binding Descricao}"
                                Title="Selecione um item"
                                Grid.Column="0" />
                        <Entry Text="{Binding Quantidade}"
                               Placeholder="Qtd"
                               Keyboard="Numeric"
                               WidthRequest="60"
                               Grid.Column="1" />
                    </Grid>

                    <Button Text="Adicionar"
                            Command="{Binding AdicionarItemCommand}"
                            BackgroundColor="#2196F3"
                            TextColor="White"
                            HorizontalOptions="End" />

                    <!-- Lista de Itens (EXPANDE AUTOMATICAMENTE) -->
                    <CollectionView ItemsSource="{Binding Pedido.Itens}"
                                    EmptyView="Nenhum item adicionado ainda.">
                        <CollectionView.ItemTemplate>
                            <DataTemplate>
                                <Frame BackgroundColor="#2F4F4F"
                                       Padding="10"
                                       Margin="0,3"
                                       CornerRadius="8">
                                    <Grid ColumnDefinitions="*, Auto, Auto" ColumnSpacing="10">
                                        <VerticalStackLayout Grid.Column="0">
                                            <Label Text="{Binding Nome}"
                                                   FontSize="14"
                                                   FontAttributes="Bold"
                                                   TextColor="White" />
                                            <Label Text="{Binding Quantidade, StringFormat='{0}x'}"
                                                   FontSize="11"
                                                   TextColor="LightGray" />
                                            <Editor Text="{Binding Observacao}"
                                                    Placeholder="Obs..."
                                                    BackgroundColor="#1E2E2E"
                                                    TextColor="White"
                                                    FontSize="10"
                                                    AutoSize="TextChanges"
                                                    MaximumHeightRequest="60" />
                                        </VerticalStackLayout>
                                        <Label Text="{Binding Subtotal, StringFormat='R$ {0:F2}'}"
                                               FontSize="12"
                                               TextColor="Yellow"
                                               VerticalOptions="Center"
                                               Grid.Column="1" />
                                        <Button Text="X"
                                                Command="{Binding Source={RelativeSource AncestorType={x:Type local:PedidoPage}}, Path=BindingContext.RemoverItemCommand}"
                                                CommandParameter="{Binding .}"
                                                BackgroundColor="Transparent"
                                                TextColor="Red"
                                                FontSize="12"
                                                Grid.Column="2" />
                                    </Grid>
                                </Frame>
                            </DataTemplate>
                        </CollectionView.ItemTemplate>
                    </CollectionView>

                    <!-- Total -->
                    <BoxView HeightRequest="1" BackgroundColor="#444" Margin="0,5" />
                    <Grid ColumnDefinitions="*, Auto">
                        <Label Text="Total:" FontSize="18" FontAttributes="Bold" Grid.Column="0" />
                        <Label Text="{Binding Pedido.Total, StringFormat='R$ {0:F2}'}"
                               FontSize="18"
                               FontAttributes="Bold"
                               TextColor="Yellow"
                               Grid.Column="1" />
                    </Grid>
                </VerticalStackLayout>
            </Frame>

            <Frame BackgroundColor="SlateGray" Padding="15">
                <VerticalStackLayout Spacing="10">
                    <Label Text="Onde o cliente vai consumir?"
                           FontSize="16"
                           FontAttributes="Bold" />
                    <Picker ItemsSource="{Binding LocaisConsumo}"
                            SelectedItem="{Binding Pedido.LocalConsumo, Mode=TwoWay}"
                            Title="Selecione">
                        <Picker.ItemDisplayBinding>
                            <Binding Converter="{x:Static helpers:EnumToDescriptionConverter.Instance}" />
                        </Picker.ItemDisplayBinding>
                    </Picker>

                </VerticalStackLayout>
            </Frame>

            <!-- 2. MESA OU CARRO -->
            <Frame IsVisible="{Binding Pedido.MostrarTipoAtendimento}" BackgroundColor="SlateGray" Padding="15">
                <VerticalStackLayout Spacing="10">
                    <Label Text="Tipo de Atendimento:" FontSize="16" FontAttributes="Bold" />

                    <Grid ColumnDefinitions="*, *" ColumnSpacing="10">
                        <!-- MESA -->
                        <RadioButton GroupName="Atendimento"
                                     Content="Mesa"
                                     IsChecked="{Binding Pedido.IsMesa, Mode=TwoWay}"
                                     Grid.Column="0"/>

                        <!-- CARRO -->
                        <RadioButton GroupName="Atendimento"
                                     Content="Carro"
                                     IsChecked="{Binding Pedido.IsMesa, Converter={StaticResource InverseBooleanConverter}, Mode=TwoWay}"
                                     Grid.Column="1" />
                    </Grid>

                    <!-- Campo MESA -->
                    <StackLayout IsVisible="{Binding Pedido.IsMesa}">
                        <Label Text="Selecione a Mesa:" TextColor="SlateGray" FontSize="14" />
                        <Picker ItemsSource="{Binding Mesas}"
                                SelectedItem="{Binding Pedido.Identificador, Mode=TwoWay}"
                                Title="Mesa"/>
                    </StackLayout>

                    <!-- Campo CARRO -->
                    <StackLayout IsVisible="{Binding Pedido.IsMesa, Converter={StaticResource InverseBooleanConverter}}">
                        <Label Text="Placa do Carro:" TextColor="SlateGray" FontSize="14" />
                        <Entry Text="{Binding Pedido.Identificador, Mode=TwoWay}"
                               Keyboard="Text"
                               MaxLength="8"/>
                    </StackLayout>
                </VerticalStackLayout>
            </Frame>

            <!-- 3. LOCAL DE CONSUMO -->


            <!-- BOTÕES -->
            <Grid ColumnDefinitions="*, *" ColumnSpacing="10">
                <Button Text="Cancelar"
                        Command="{Binding CancelarCommand}"
                        BackgroundColor="#f44336"
                        TextColor="White"
                        Grid.Column="0" />
                <Button Text="Salvar Pedido"
                        Command="{Binding SalvarPedidoCommand}"
                        BackgroundColor="#4CAF50"
                        TextColor="White"
                        Grid.Column="1" />
            </Grid>

        </VerticalStackLayout>
    </ScrollView>
</ContentPage>